JAVAC = @JAVAC@
ANDROID = @ANDROID@
ANDROID_SDK_PATH = @ANDROID_HOME@
PROJECT_NAME = @PACKAGE_NAME@
DX = @DX@
AAPT = @AAPT@
JARSIGNER = @JARSIGNER@
ZIPALIGN = @ZIPALIGN@
KEYTOOL = @KEYTOOL@
MKDIR_P = @MKDIR_P@

srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
prefix = @prefix@

RDNS = "com/qdii/$(PROJECT_NAME)"
RRDNS = $(srcdir)/src/$(RDNS)
OBJ = $(builddir)/obj
LIB = $(srcdir)/libs
BOOTSTRAP_CLASSPATH = @android_bootstrap_classpath@
TARGET_ID = @TATOPARSER_TARGET_ID@
TARGET_VM = 1.6
TARGET_VM_SOURCE = 1.6

KEYSTORE_PASSWORD = "android"
KEYSTORE_ALIAS = "androiddebugkey"
KEYSTORE_FILE = "$(srcdir)/$(PROJECT_NAME).keystore"

ANDROID_CLASSPATH = "$(ANDROID_SDK_PATH)/platforms/$(TARGET_ID)/android.jar"
ANDROID_FLAGS = -bootclasspath "$(BOOTSTRAP_CLASSPATH)" -classpath "$(ANDROID_CLASSPATH):$(OBJ)" -sourcepath "$(srcdir)" -d "$(OBJ)" -target $(TARGET_VM) -source $(TARGET_VM_SOURCE)

SOURCE_FILES = $(RRDNS)/ActivitySearch.java	$(RRDNS)/Sentence.java
OBJ_FILES = $(SOURCE_FILES:.java=.class)

all: create-obj-directory update-project compile-r-file $(OBJ_FILES) dexify compile-native create-apk generate-keystore sign-apk align-apk

create-obj-directory:
	$(MKDIR_P) $(OBJ)

create-apk: $(PROJECT_NAME).unsigned.apk

generate-keystore: $(PROJECT_NAME).keystore

$(PROJECT_NAME).keystore:
	$(KEYTOOL) -genkeypair -v -keystore $(KEYSTORE_FILE) -alias $(KEYSTORE_ALIAS) -keyalg RSA -keysize 2048 -validity 20000 -storepass $(KEYSTORE_PASSWORD)

$(PROJECT_NAME).unsigned.apk:
	$(AAPT) package -M $(srcdir)/AndroidManifest.xml -S $(srcdir)/res -I $(ANDROID_CLASSPATH) -F $@ $(OBJ)

sign-apk: $(PROJECT_NAME).unsigned.apk $(PROJECT_NAME).unaligned.apk

$(PROJECT_NAME).unaligned.apk:
	$(JARSIGNER) -keystore $(KEYSTORE_FILE) -storepass $(KEYSTORE_PASSWORD) -keypass $(KEYSTORE_PASSWORD) -signedjar "$(PROJECT_NAME).unaligned.apk" "$(PROJECT_NAME).unsigned.apk" $(KEYSTORE_ALIAS)

align-apk: create-apk sign-apk $(PROJECT_NAME).apk

$(PROJECT_NAME).apk:
	$(ZIPALIGN) -f 4 $(PROJECT_NAME).unaligned.apk $(PROJECT_NAME).apk

update-project:
	$(ANDROID) update project --name "$(PROJECT_NAME)" --target "$(TARGET_ID)" --path $(srcdir)

%.class:
	$(JAVAC) $(ANDROID_FLAGS) $*.java

compile-r-file: $(srcdir)/gen/$(RDNS)/R.class	$(srcdir)/gen/$(RDNS)/BuildConfig.class

dexify:
	$(DX) --dex --verbose --output=$(OBJ)/classes.dex $(OBJ) $(LIB)

clean:
	$(RM) $(OBJ_FILES)
	$(RM) $(OBJ)/*.class
	$(RM) $(PROJECT_NAME).unsigned.apk
	$(RM) $(PROJECT_NAME).unaligned.apk
	$(RM) $(PROJECT_NAME).apk
	$(RM) $(OBJ)/classes.dex

compile-native:
	cd $(top_srcdir)/src && $(MAKE) android-ndk

install:
	$(MKDIR_P) $(prefix)/bin
	install -m 0755 $(PROJECT_NAME).apk $(prefix)/bin

uninstall:
	$(RM) $(prefix)/bin/$(PROJECT_NAME).apk

Makefile: Makefile.in
	cd $(top_srcdir) && ./config.status src/java/$@

.PHONY: clean dexify compile-native all install uninstall generate-keystore create-apk sign-apk align-apk
