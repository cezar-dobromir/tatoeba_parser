JAVAC = @JAVAC@
ANDROID = @ANDROID@
ANDROID_SDK_PATH = @ANDROID_HOME@
PROJECT_NAME = @PACKAGE_NAME@
DX = @DX@
AAPT = @AAPT@
JARSIGNER = @JARSIGNER@
ZIPALIGN = @ZIPALIGN@
KEYTOOL = @KEYTOOL@
MKDIR_P = @MKDIR_P@
LN_S = @LN_S@
INSTALL = @INSTALL@

srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
prefix = @prefix@

RDNS = com/qdii/$(PROJECT_NAME)
RRDNS = $(srcdir)/src/$(RDNS)
OBJ = $(builddir)/obj
LIB = $(srcdir)/libs
NATIVE_LIB_PATH = $(OBJ)/lib/armeabi
BOOTSTRAP_CLASSPATH = @android_bootstrap_classpath@
TARGET_ID = @TATOPARSER_TARGET_ID@
TARGET_VM = 1.6
TARGET_VM_SOURCE = 1.6

KEYSTORE_PASSWORD = "android"
KEYSTORE_ALIAS = "androiddebugkey"
KEYSTORE_FILE = "$(srcdir)/$(PROJECT_NAME).keystore"

ANDROID_CLASSPATH = "$(ANDROID_SDK_PATH)/platforms/$(TARGET_ID)/android.jar"
ANDROID_FLAGS = -bootclasspath "$(BOOTSTRAP_CLASSPATH)" -classpath "$(ANDROID_CLASSPATH):$(OBJ)" -sourcepath "$(srcdir)" -d "$(OBJ)" -target $(TARGET_VM) -source $(TARGET_VM_SOURCE)

GEN_FILES = $(RDNS)/BuildConfig.java $(RDNS)/R.java
SOURCE_FILES = $(RDNS)/ActivitySearch.java $(RDNS)/Sentence.java
OBJ_FILES = $(patsubst %.java,$(OBJ)/%.class,$(GEN_FILES)) $(patsubst %.java,$(OBJ)/%.class,$(SOURCE_FILES))

all: create-obj-directory $(OBJ_FILES) dexify create-apk generate-keystore sign-apk align-apk

create-obj-directory:
	$(MKDIR_P) $(OBJ)
	$(MKDIR_P) $(NATIVE_LIB_PATH)

create-apk: $(PROJECT_NAME).unsigned.apk

generate-keystore: $(PROJECT_NAME).keystore

$(PROJECT_NAME).keystore:
	$(KEYTOOL) -genkeypair -v -keystore $(KEYSTORE_FILE) -alias $(KEYSTORE_ALIAS) -keyalg RSA -keysize 2048 -validity 20000 -storepass $(KEYSTORE_PASSWORD)

$(PROJECT_NAME).unsigned.apk: $(NATIVE_LIB_PATH)/lib$(PROJECT_NAME).so
	$(AAPT) package -f -M $(srcdir)/AndroidManifest.xml -S $(srcdir)/res -I $(ANDROID_CLASSPATH) -F $@ $(OBJ)

sign-apk: $(PROJECT_NAME).unsigned.apk $(PROJECT_NAME).unaligned.apk

$(PROJECT_NAME).unaligned.apk:
	$(JARSIGNER) -keystore $(KEYSTORE_FILE) -storepass $(KEYSTORE_PASSWORD) -keypass $(KEYSTORE_PASSWORD) -signedjar "$(PROJECT_NAME).unaligned.apk" "$(PROJECT_NAME).unsigned.apk" $(KEYSTORE_ALIAS)

align-apk: create-apk sign-apk $(PROJECT_NAME).apk

$(PROJECT_NAME).apk:
	$(ZIPALIGN) -f 4 $(PROJECT_NAME).unaligned.apk $(PROJECT_NAME).apk

update-project:
	$(ANDROID) update project --name "$(PROJECT_NAME)" --target "$(TARGET_ID)" --path $(srcdir)

obj/$(RDNS)/BuildConfig.class: $(srcdir)/gen/$(RDNS)/BuildConfig.java
	$(JAVAC) $(ANDROID_FLAGS) $(srcdir)/gen/$(RDNS)/BuildConfig.java

obj/$(RDNS)/R.class: $(srcdir)/gen/$(RDNS)/R.java
	$(JAVAC) $(ANDROID_FLAGS) $(srcdir)/gen/$(RDNS)/R.java

$(OBJ)/$(RDNS)/%.class: $(srcdir)/src/$(RDNS)/%.java
	$(JAVAC) $(ANDROID_FLAGS) $<

dexify:
	$(DX) --dex --output=$(OBJ)/classes.dex $(OBJ)

clean:
	$(RM) $(OBJ)/$(RDNS)/*.class
	$(RM) $(NATIVE_LIB_PATH)/lib$(PROJECT_NAME).so
	$(RM) $(PROJECT_NAME).unsigned.apk
	$(RM) $(PROJECT_NAME).unaligned.apk
	$(RM) $(PROJECT_NAME).apk
	$(RM) $(OBJ)/classes.dex

$(NATIVE_LIB_PATH)/lib$(PROJECT_NAME).so: $(srcdir)/../libs/armeabi/lib$(PROJECT_NAME).so
	$(INSTALL) -v $(srcdir)/../libs/armeabi/lib$(PROJECT_NAME).so $(NATIVE_LIB_PATH)

$(srcdir)/../libs/armeabi/lib$(PROJECT_NAME).so:
	cd .. && make android-ndk && cd java

install:
	$(MKDIR_P) $(prefix)/bin
	$(INSTALL) $(PROJECT_NAME).apk $(prefix)/bin

uninstall:
	$(RM) $(prefix)/bin/$(PROJECT_NAME).apk

Makefile: Makefile.in
	cd $(top_srcdir) && ./config.status src/java/$@

.PHONY: clean dexify all install uninstall generate-keystore create-apk sign-apk align-apk update-project create-obj-directory
